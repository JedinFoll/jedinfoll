<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jedi√± Foll ‚Äî Jeu √©ducatif, dr√¥le et strat√©gique</title>
  <link rel="alternate" hreflang="en" href="/jedinfoll/index-en.html">
  <style>
    :root{--mint:#2ec4b6;--bg:#1a1a1a}
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,sans-serif;background-color:var(--mint);color:#fff}
    header,footer{text-align:center;padding:1rem;background:var(--bg)}
    main{max-width:900px;margin:auto;padding:1rem}
    .topbar{display:flex;justify-content:space-between;align-items:center;max-width:900px;margin:0 auto}
    .lang{font-weight:bold}.lang a{color:#ffcb77;text-decoration:none;margin-left:.5rem}
    .card{background:var(--bg);border-radius:20px;padding:1.5rem;box-shadow:0 4px 12px rgba(0,0,0,.5);margin:1rem auto 2rem}
    h1,h2{color:#fff;margin:0 0 .5rem} h2{color:var(--mint)}
    .price{font-size:1.8rem;font-weight:bold;margin:1rem 0}
    .btn{display:inline-block;padding:.8rem 1.2rem;border-radius:10px;background:linear-gradient(90deg,#00b4d8,#ffcb77);color:#000;font-weight:bold;text-decoration:none}
    .qr{text-align:center;margin-top:1rem}
    .social-links a{color:var(--mint);text-decoration:none;margin:0 10px;font-weight:bold}
    .mentions{font-size:.95rem;color:#ddd;margin-top:1rem;text-align:left;line-height:1.55}
    .flags-inline{display:inline-flex;align-items:center;gap:6px}
    .flag{height:16px;border-radius:2px;border:1px solid #333}
    .small{color:#bbb;font-size:.9rem}
    ul{padding-left:1.2rem}
    .pdf-frame{width:100%;aspect-ratio:1/1.414;max-height:80vh;border:0;background:#fff}
    @media (max-width:600px){.pdf-frame{aspect-ratio:auto;height:70vh}}
    @media print{body{background:#fff;color:#000} header,footer,.card:not(#rules){display:none!important} #rules{box-shadow:none;border:none;background:#fff;color:#000} #rules h2{color:#000}}
    /* Avis & √©toiles */
    .stars{font-size:1.8rem;user-select:none;display:flex;gap:.1rem}
    .avg-banner{display:flex;gap:.5rem;align-items:center;margin:.25rem 0 .75rem;flex-wrap:wrap}
    .avg-stars{font-size:1.6rem}
    .avg-badges{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .badge{background:#0f0f0f;border:1px solid #2a2a2a;color:#fff;border-radius:999px;padding:.2rem .6rem;font-size:.85rem}
    .reviews-list{display:flex;flex-direction:column;gap:1rem;margin-top:1rem}
    .review{background:#111;border:1px solid #2a2a2a;border-radius:12px;padding:1rem}
    .review-header{display:flex;align-items:center;gap:.6rem;margin-bottom:.4rem;font-size:.95rem;color:#ddd}
    .review-author{font-weight:bold;color:#fff}
    .review-date{color:#bbb;font-size:.9rem}
    .review-stars{color:#ffcb77;letter-spacing:.05em}
    .review-body{white-space:pre-wrap;line-height:1.45}
    .review-empty{color:#bbb;font-style:italic}
    .reviews-actions{margin-top:1rem;display:flex;gap:.6rem;flex-wrap:wrap}
    .reviews-actions .btn{background:linear-gradient(90deg,#2ec4b6,#ffcb77)}
    #allReviewsPanel{margin-top:1rem;border-top:1px dashed #2a2a2a;padding-top:1rem}
    #allReviewsList{display:flex;flex-direction:column;gap:1rem}
    #loadMoreBtn{display:none}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div></div>
      <div class="lang">FR / <a href="/jedinfoll/index-en.html">EN</a></div>
    </div>
    <h1>Jedi√± Foll</h1>
    <p>Le jeu de cartes √©ducatif, dr√¥le et strat√©gique</p>
  </header>

  <main>
    <div class="card">
      <h2>Jedi√± Foll</h2>
      <ul>
        <li>1 √† 4 joueurs ¬∑ 10 √† 30 minutes</li>
        <li>√Ä partir de 6 ans</li>
        <li>5 modes de jeu ‚Äî atteindre exactement le r√©sultat demand√© selon le mode choisi</li>
        <li>La bo√Æte contient 102 cartes</li>
      </ul>
    </div>

    <div class="card" id="rules">
      <h2>R√®gles du jeu</h2>
      <p class="small">Lecture directe ci-dessous ‚Ä¢ <a class="btn" href="/jedinfoll/regles.pdf" download>T√©l√©charger le PDF</a></p>
      <object data="/jedinfoll/regles.pdf" type="application/pdf" class="pdf-frame">
        <iframe src="/jedinfoll/regles.pdf" class="pdf-frame" title="R√®gles"></iframe>
      </object>
      <p class="small">Si le PDF ne s‚Äôaffiche pas, <a href="/jedinfoll/regles.pdf" download>cliquez ici pour le t√©l√©charger</a>.</p>
      <button class="btn" onclick="window.print()">üìÑ Imprimer la section R√®gles</button>
    </div>

    <!-- Vid√©o -->
    <div class="card" id="videos">
      <h2>Vid√©os</h2>
      <div style="aspect-ratio:16/9; max-width:100%;">
        <iframe width="100%" height="100%" src="https://www.youtube.com/embed/ID_DE_TA_VIDEO" title="Jedi√± Foll ‚Äî D√©mo" frameborder="0" allowfullscreen></iframe>
      </div>
    </div>

    <!-- Pr√©commande -->
    <div class="card" id="pricing">
      <h2>Pr√©commande</h2>
      <div class="price">14,99 ‚Ç¨</div>

      <!-- France (livraison) -->
      <a href="https://www.paypal.com/ncp/payment/3MJTT9P62VJKY" class="btn">
        üá´üá∑ Pr√©commande France ‚Äî 14,99 ‚Ç¨ + 5 ‚Ç¨ livraison
      </a>

      <!-- Martinique (retrait sur place) -->
      <a href="https://www.paypal.com/ncp/payment/B3JBUBJQBNQWJ" class="btn" style="margin-left:10px; background:linear-gradient(90deg,#06d6a0,#ffd166);">
        üá≤üá∂ Pr√©commande Martinique ‚Äî 14,99 ‚Ç¨ (Retrait sur place)
      </a>

      <p class="small" style="margin-top:.8rem;">
        ‚è≥ Disponible √† partir de <strong>mi-juin 2026</strong> (ou plus t√¥t selon la production).<br>
        üì¶ France : ajouter 5 ‚Ç¨ pour la livraison.<br>
        üìç Martinique : retrait sur place uniquement (pas d‚Äôexp√©dition).
      </p>
    </div>

    <!-- QR Code -->
    <div class="card">
      <h2>QR Code</h2>
      <div class="qr">
        <a href="https://api.qrserver.com/v1/create-qr-code/?size=2000x2000&data=https://jedinfoll.github.io/jedinfoll/" download>
          <img src="https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=https://jedinfoll.github.io/jedinfoll/" alt="QR Code vers Jedi√± Foll" style="max-width:300px;">
        </a>
      </div>
      <p class="small">Cliquez sur le QR pour t√©l√©charger en HD.</p>
    </div>

    <!-- Avis & Note -->
    <div class="card" id="reviews">
      <h2>Avis & Note</h2>

      <!-- Bandeau moyenne visible -->
      <div class="avg-banner" aria-live="polite">
        <div id="avgStars" class="stars avg-stars" aria-label="Note moyenne">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
        <div class="avg-badges">
          <span class="badge">Moyenne : <strong><span id="avgValue">‚Äî</span>/5</strong></span>
          <span class="badge">Votes : <strong><span id="totalVotes">0</span></strong></span>
          <span class="badge">Avis : <strong><span id="totalReviews">0</span></strong></span>
        </div>
      </div>

      <!-- Formulaire int√©gr√© -->
      <div class="review-form" style="margin-top:1rem;">
        <p class="small">Laissez votre note (1‚Äì5) et votre avis ci-dessous, puis cliquez sur <em>Envoyer</em>. L‚Äôenregistrement est imm√©diat.</p>
        <div style="width:100%; max-height:700px; overflow:auto; border:1px solid #2a2a2a; border-radius:12px;">
          <iframe id="reviewForm" src="https://docs.google.com/forms/d/e/1FAIpQLSdzVO_ZXOXcISfR6lX2gu30EFih8wZrYCdVjjNHtn_QqsLDIg/viewform?embedded=true" width="100%" height="700" frameborder="0" marginheight="0" marginwidth="0" style="background:#0f0f0f;">Chargement‚Ä¶</iframe>
        </div>
        <button id="refreshBtn" class="btn" type="button" style="margin-top:.8rem;">üîÑ Actualiser la moyenne et les avis</button>
      </div>

      <!-- 3 derniers avis -->
      <div class="reviews-list" id="latestReviews">
        <div class="review-empty">Chargement des derniers avis‚Ä¶</div>
      </div>

      <!-- Tous les avis -->
      <div class="reviews-actions">
        <button id="showAllReviewsBtn" class="btn" type="button">üìñ Lire tous les avis</button>
      </div>

      <div id="allReviewsPanel" hidden>
        <div id="allReviewsStatus" class="small">Chargement‚Ä¶</div>
        <div id="allReviewsList"></div>
        <button id="loadMoreBtn" class="btn" type="button">Charger plus</button>
      </div>
    </div>

    <div class="card mentions">
      <h2>Mentions l√©gales</h2>
      <p><strong>√âditeur :</strong> Jedi√± Foll ‚Äî Email : <a href="mailto:jedinfoll@gmail.com">jedinfoll@gmail.com</a></p>
      <p><strong>Responsable de publication :</strong> Jessica Lechertier</p>
      <p><strong>Fabrication :</strong> Cr√©√© en
        <span class="flags-inline">Martinique
          <img src="https://raw.githubusercontent.com/jedinfoll/jedinfoll/main/1000079688.jpg" alt="" class="flag">
        </span>.
      </p>
      <p><strong>H√©bergement :</strong> GitHub Pages ‚Äî GitHub Inc., 88 Colin P Kelly Jr St, San Francisco, CA 94107, USA.</p>
      <p><strong>Propri√©t√© intellectuelle :</strong> Contenus ¬© Jedi√± Foll. Reproduction interdite sans autorisation.</p>
      <p><strong>Donn√©es personnelles :</strong> Les avis/notes sont stock√©s par Google Forms/Sheets.</p>
    </div>
  </main>

  <footer>
    <div class="social-links">
      <a href="https://www.instagram.com/jedinfoll" target="_blank">Instagram: @jedinfoll</a> |
      <a href="https://www.facebook.com/Jedi%C3%B1%20Foll" target="_blank">Facebook: Jedi√± Foll</a> |
      <a href="mailto:jedinfoll@gmail.com">Email: jedinfoll@gmail.com</a>
    </div>
    <p>¬© 2025 Jedi√± Foll ‚Äî Tous droits r√©serv√©s.</p>
  </footer>

  <script>
    (function(){
      /* URL CSV publi√©e (ta feuille Google) */
      const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQqh2gKDBWqoVbV4hCGADf7UTo5qKHcXk0LGL3mSs0oIrHDekGbYMfugFDLBdoxfptEFbYRedARxrJ5/gviz/tq?tqx=out:csv&gid=1219615797';
      const PER_PAGE = 20;

      const $ = id => document.getElementById(id);
      const escapeHTML = s => (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

      const avgStars = $('avgStars'), avgValue = $('avgValue'), totalVotes = $('totalVotes'), totalReviews = $('totalReviews');
      const latestBox = $('latestReviews');
      const showAllBtn = $('showAllReviewsBtn');
      const allPanel = $('allReviewsPanel');
      const allList = $('allReviewsList');
      const loadMoreBtn = $('loadMoreBtn');
      const statusEl = $('allReviewsStatus');

      /* CSV parsing */
      function parseCSV(text){
        const rows=[]; let cur=[], val='', inQ=false;
        for(let i=0;i<text.length;i++){
          const c=text[i], n=text[i+1];
          if(inQ){
            if(c=='"' && n=='"'){ val+='"'; i++; }
            else if(c=='"'){ inQ=false; }
            else { val+=c; }
          }else{
            if(c=='"'){ inQ=true; }
            else if(c==','){ cur.push(val); val=''; }
            else if(c=='\n' || c=='\r'){ if(val!==''||cur.length){ cur.push(val); rows.push(cur); cur=[]; val=''; } }
            else { val+=c; }
          }
        }
        if(val!==''||cur.length){ cur.push(val); rows.push(cur); }
        return rows;
      }

      /* D√©tecte colonnes (fr/eng) */
      function getCols(header){
        return {
          ts:  header.findIndex(h=>/time|date|horodatage|timestamp/i.test(h)) ?? 0,
          note:header.findIndex(h=>/note|rating|√©chelle|scale/i.test(h)) ?? 1,
          avis:header.findIndex(h=>/avis|commentaire|comment/i.test(h)) ?? 2,
          nom: header.findIndex(h=>/nom|name/i.test(h)) ?? -1
        };
      }

      function compute(rows){
        if(rows.length<=1) return {avg:0, votes:0, reviews:0, items:[]};
        const header = rows[0];
        const data = rows.slice(1).filter(r=>r.some(c=>String(c).trim() !== ''));
        const cols = getCols(header);
        let sum=0, votes=0, reviews=0;
        const items=[];
        data.forEach(r=>{
          const rawNote = (r[cols.note]||'').toString().replace(',','.');
          const note = Math.round(Number(rawNote) || 0);
          const avis = (r[cols.avis]||'').toString().trim();
          const nom  = cols.nom>=0 ? (r[cols.nom]||'').toString().trim() : '';
          const ts   = r[cols.ts] || '';
          if(note>0){ votes++; sum += note; }
          if(avis){
            items.push({timestamp: ts, rating: Math.max(1,Math.min(5,note)), text: avis, name: nom});
            reviews++;
          }
        });
        const avg = votes ? (sum/votes) : 0;
        items.sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));
        return {avg, votes, reviews, items};
      }

      function paintAvg(avg, votes, reviews){
        const n = Math.round(avg||0);
        avgStars.textContent = '‚òÖ'.repeat(n) + '‚òÜ'.repeat(5-n);
        avgValue.textContent = votes ? avg.toFixed(1) : '‚Äî';
        totalVotes.textContent = votes.toString();
        totalReviews.textContent = reviews.toString();
      }

      function reviewCard(r){
        const date = new Date(r.timestamp).toLocaleDateString('fr-FR');
        const stars = '‚òÖ'.repeat(r.rating) + '‚òÜ'.repeat(5-r.rating);
        const name = r.name ? '@'+escapeHTML(r.name) : '@Visiteur';
        return `<div class="review">
          <div class="review-header">
            <span class="review-author">${name}</span>
            <span class="review-date">¬∑ ${escapeHTML(date)}</span>
            <span class="review-stars">‚Äî ${stars}</span>
          </div>
          <div class="review-body">${escapeHTML(r.text)}</div>
        </div>`;
      }

      async function loadStatsAndLatest(){
        latestBox.innerHTML = `<div class="review-empty">Chargement‚Ä¶</div>`;
        try{
          const resp = await fetch(CSV_URL, {cache:'no-store'});
          const txt = await resp.text();
          const rows = parseCSV(txt);
          const {avg, votes, reviews, items} = compute(rows);
          paintAvg(avg, votes, reviews);
          const last3 = items.slice(0,3);
          latestBox.innerHTML = last3.length ? last3.map(reviewCard).join('') : `<div class="review-empty">Pas encore d'avis.</div>`;
        }catch{
          latestBox.innerHTML = `<div class="review-empty">Impossible de charger les avis.</div>`;
        }
      }

      /* Tous les avis (pagination) */
      let page = 0;
      function showAll(){
        allPanel.hidden = false;
        statusEl.textContent = 'Chargement‚Ä¶';
        allList.innerHTML = '';
        page = 0;
        loadMore();
      }
      async function loadMore(){
        try{
          const resp = await fetch(CSV_URL, {cache:'no-store'});
          const txt = await resp.text();
          const rows = parseCSV(txt);
          const {items} = compute(rows);
          const slice = items.slice(page*PER_PAGE, (page+1)*PER_PAGE);
          if(slice.length===0){
            statusEl.textContent = page===0 ? 'Aucun avis.' : 'Tous les avis sont affich√©s.';
            loadMoreBtn.style.display='none';
            return;
          }
          const wrap = document.createElement('div');
          wrap.className='reviews-list';
          wrap.innerHTML = slice.map(reviewCard).join('');
          allList.appendChild(wrap);
          page++;
          statusEl.textContent = '';
          loadMoreBtn.style.display = (items.length > page*PER_PAGE) ? 'inline-block' : 'none';
        }catch{
          statusEl.textContent = 'Erreur de chargement.';
          loadMoreBtn.style.display='none';
        }
      }

      $('refreshBtn').addEventListener('click', loadStatsAndLatest);
      $('showAllReviewsBtn').addEventListener('click', showAll);
      $('loadMoreBtn').addEventListener('click', loadMore);

      // Init
      loadStatsAndLatest();
    })();
  </script>
</body>
</html>
